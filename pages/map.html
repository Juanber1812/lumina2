<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Addis Ababa Soil Analysis Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="../style.css" />

  <style>
    /* === MAP PAGE LAYOUT === */
    body { 
      display: flex; 
      flex-direction: row; 
      margin: 0; 
      padding: 0; 
      font-family: Arial, Helvetica, sans-serif; 
      height: 100vh; 
      overflow: hidden;
    }

    #map-container {
      flex: 1;
      height: 100vh;
      order: 1;
      position: relative;
    }

    #map { 
      width: 100%; 
      height: 100%; 
    }

    #layer-sidebar { 
      width: 300px; 
      background: #1e1e2f; 
      color: white; 
      font: 14px/1.4 Arial, Helvetica, sans-serif; 
      padding: 20px 15px; 
      box-sizing: border-box; 
      overflow-y: auto; 
      height: 100vh; 
      order: 2;
    }

    #layer-sidebar h1 { 
      font-size: 18px; 
      margin: 0 0 20px; 
      color: #fff; 
      text-align: center; 
      border-bottom: 2px solid #2c2c3e; 
      padding-bottom: 10px; 
    }

    #layer-sidebar .layer-item { 
      margin: 6px 0; 
      padding: 12px 15px; 
      border-radius: 6px; 
      cursor: pointer; 
      background: #2c2c3e; 
      border: 1px solid #3b3b52; 
      transition: all 0.3s; 
      font-size: 15px; 
    }

    #layer-sidebar .layer-item:hover { 
      background: #3b3b52; 
      border-color: #4a4a65; 
      transform: translateX(-3px); 
    }

    #layer-sidebar .layer-item.active { 
      background: #0078d4; 
      border-color: #106ebe; 
      color: #fff; 
      box-shadow: -2px 0 8px rgba(0,120,212,0.3); 
    }

    #legend { 
      margin-top: 25px; 
      padding: 15px; 
      background: #2c2c3e; 
      border-radius: 8px; 
      border: 1px solid #3b3b52; 
    }

    #legend strong { 
      color: #fff; 
      font-size: 16px; 
    }

    #legend canvas { 
      width: 100%; 
      height: 35px; 
      border: 1px solid #3b3b52; 
      display: block; 
      margin-top: 8px; 
      border-radius: 6px; 
    }

    #legend .scale-range { 
      display: flex; 
      justify-content: space-between; 
      font-size: 12px; 
      margin-top: 6px; 
      color: #ccc; 
    }

    .loading { 
      font-size: 13px; 
      color: #aaa; 
      margin-top: 15px; 
      text-align: center; 
    }

    #legend-notes { 
      font-size: 12px; 
      margin-top: 8px; 
      line-height: 1.4; 
      color: #ccc; 
    }

    hr { 
      margin: 20px 0; 
      border: none; 
      border-top: 1px solid #3b3b52; 
    }

    #status { 
      padding: 8px 12px; 
      background: #2c2c3e; 
      border-radius: 6px; 
      border: 1px solid #3b3b52; 
    }

    /* === POPUP DESCRIPTION STYLING === */
    .metric-popup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      display: none;
    }

    .metric-popup .popup-content {
      background: #1e1e2f;
      color: white;
      border-radius: 10px;
      max-width: 500px;
      padding: 25px 30px;
      box-shadow: 0 4px 25px rgba(0,0,0,0.5);
      font-family: "Poppins", sans-serif;
      line-height: 1.6;
    }

    .metric-popup h2 {
      margin-top: 0;
      font-size: 1.4rem;
      color: #4fc3f7;
    }

    .metric-popup p {
      font-size: 1.05rem;
      margin-bottom: 0;
    }

  </style>
</head>

<body>
  <div id="map-container">
    <div id="map"></div>
  </div>

  <div id="layer-sidebar">
    <h1>üåç Soil Analysis Layers</h1>
    <div id="layer-list"></div>

    <div id="opacity-control" style="margin: 15px 0; padding: 12px; background: #2c2c3e; border-radius: 6px; border: 1px solid #3b3b52;">
      <label for="opacity-slider" style="display: block; margin-bottom: 8px; font-size: 14px; color: #fff;">
        üéö Layer Opacity: <span id="opacity-value">75%</span>
      </label>
      <input type="range" id="opacity-slider" min="0" max="100" value="75" 
             style="width: 100%; background: #1e1e2f; border-radius: 3px;">
    </div>

    <div id="legend">
      <strong>Legend</strong>
      <canvas id="legend-bar" width="250" height="35"></canvas>
      <div class="scale-range">
        <span id="min-val">min</span>
        <span id="mid-val">mid</span>
        <span id="max-val">max</span>
      </div>
      <div id="legend-notes">Select a layer to view legend</div>
    </div>

    <div id="status" class="loading">Loading raster data...</div>
    <hr />
    <p style="font-size:11px; color: #999;">
      üìä Soil Moisture: 1‚Äì5 (red‚Üígreen), 5‚Äì10 (green‚Üíblue)<br/>
      üìà Others: min‚Üímax (red‚Üíyellow‚Üígreen)
    </p>
  </div>

  <!-- Metric Description Popup -->
  <div id="metric-popup" class="metric-popup">
    <div class="popup-content">
      <span id="close-popup" style="float:right; cursor:pointer;">‚úñ</span>
      <h2 id="popup-title"></h2>
      <p id="popup-text"></p>
    </div>
  </div>

  <!-- Leaflet + GeoTIFF Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist/geotiff.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/georaster@1.5.4/dist/georaster.browser.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/georaster-layer-for-leaflet@3.1.0/dist/georaster-layer-for-leaflet.min.js"></script>

  <!-- Client-side analysis engine -->
  <script src="../client-analysis.js"></script>

  <!-- Main Map Script -->
  <script src="../script.js"></script>
  
  <!-- Dynamic Layer Management -->
  <script src="../dynamic-layers.js"></script>
</body>
</html>